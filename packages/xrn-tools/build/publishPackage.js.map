{"version":3,"file":"publishPackage.js","sourceRoot":"","sources":["../src/publishPackage.ts"],"names":[],"mappings":";;AAOA,wCA+DC;AAtED,mCAA0D;AAOnD,KAAK,UAAU,cAAc,CAAC,EACnC,WAAW,EACX,MAAM,GAAG,KAAK,GACC;IACf,IAAI,CAAC;QACH,MAAM,OAAO,GAAG,MAAM,IAAA,4BAAoB,EAAC,WAAW,CAAC,CAAC;QACxD,IAAI,CAAC,OAAO,EAAE,CAAC;YACb,OAAO,CAAC,KAAK,CAAC,GAAG,WAAW,MAAM,CAAC,CAAC;YACpC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;QAClB,CAAC;QACD,MAAM,WAAW,GAAG,OAAO,CAAC,GAAG,EAAE,CAAC;QAClC,OAAO,CAAC,KAAK,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC;QAChC,SAAS;QACT,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,IAAA,iBAAS,EAAC,iCAAiC,CAAC,CAAC;QACtE,MAAM,MAAM,GAAG,MAAM,CAAC,IAAI,EAAE,CAAC;QAC7B,MAAM,OAAO,GAAG,MAAM,CAAC;QAEvB,OAAO,CAAC,IAAI,CAAC,GAAG,WAAW,UAAU,MAAM,cAAc,OAAO,EAAE,CAAC,CAAC;QAEpE,MAAM,QAAQ,GAAG,MAAM,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAC;QAC5C,MAAM,SAAS,GAAG,MAAM,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAC;QAE9C,4BAA4B;QAC5B,IAAI,CAAC,SAAS,EAAE,CAAC;YACf,MAAM,IAAA,iBAAS,EACb,iCAAiC,OAAO,qCAAqC,WAAW,qBAAqB,CAC9G,CAAC;YACF,MAAM,IAAA,iBAAS,EAAC,wBAAwB,CAAC,CAAC;YAE1C,MAAM,IAAA,iBAAS,EAAC,iCAAiC,MAAM,EAAE,CAAC,CAAC;QAC7D,CAAC;aAAM,IAAI,SAAS,EAAE,CAAC;YACrB,MAAM,IAAA,iBAAS,EACb,kCAAkC,WAAW,yCAAyC,CACvF,CAAC;YACF,MAAM,IAAA,iBAAS,EAAC,aAAa,CAAC,CAAC;YAC/B,MAAM,IAAA,iBAAS,EAAC,iCAAiC,MAAM,EAAE,CAAC,CAAC;QAC7D,CAAC;aAAM,CAAC;YACN,OAAO,CAAC,KAAK,CACX,GAAG,WAAW,mCAAmC,CAClD,CAAC;YACF,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;QAClB,CAAC;QAED,OAAO,CAAC,GAAG,CAAC,GAAG,WAAW,SAAS,CAAC,CAAC;QAErC,OAAO,CAAC,KAAK,CAAC,WAAW,CAAC,CAAC;QAE3B,YAAY;QACZ,MAAM,IAAA,iBAAS,EAAC,kCAAkC,WAAW,EAAE,CAAC,CAAC;QAEjE,MAAM,IAAA,iBAAS,EAAC,6BAA6B,EAAE,EAAE,KAAK,EAAE,SAAS,EAAE,CAAC,CAAC;QAErE,SAAS;QACT,MAAM,EAAE,MAAM,EAAE,GAAG,EAAE,GAAG,MAAM,IAAA,iBAAS,EAAC,wBAAwB,CAAC,CAAC;QAClE,IAAI,GAAG,CAAC,IAAI,EAAE,EAAE,CAAC;YACf,MAAM,IAAA,iBAAS,EAAC,WAAW,CAAC,CAAC;YAC7B,MAAM,IAAA,iBAAS,EAAC,+BAA+B,CAAC,CAAC;YACjD,MAAM,IAAA,iBAAS,EAAC,mBAAmB,MAAM,EAAE,CAAC,CAAC;QAC/C,CAAC;IACH,CAAC;IAAC,OAAO,KAAK,EAAE,CAAC;QACf,OAAO,CAAC,KAAK,CAAC,2BAA2B,EAAE,KAAK,CAAC,CAAC;QAClD,MAAM,KAAK,CAAC;IACd,CAAC;AACH,CAAC","sourcesContent":["import { execAsync, findWorkspacePackage } from \"./utils\";\n\ninterface PublishOptions {\n  packageName: string;\n  isBeta?: boolean;\n}\n\nexport async function publishPackage({\n  packageName,\n  isBeta = false,\n}: PublishOptions) {\n  try {\n    const pkgInfo = await findWorkspacePackage(packageName);\n    if (!pkgInfo) {\n      console.error(`${packageName} 不存在`);\n      process.exit(1);\n    }\n    const catchedPath = process.cwd();\n    process.chdir(pkgInfo.location);\n    // 获取当前分支\n    const { stdout } = await execAsync(`git rev-parse --abbrev-ref HEAD`);\n    const branch = stdout.trim();\n    const betaTag = \"beta\";\n\n    console.info(`${packageName}-当前分支是：${branch}, betaTag是：${betaTag}`);\n\n    const isStable = branch.endsWith(\"-stable\");\n    const isRelease = branch.endsWith(\"-release\");\n\n    // if (isBeta || isStable) {\n    if (!isRelease) {\n      await execAsync(\n        `standard-version --prerelease ${betaTag} --release-as patch --tag-prefix \"${packageName}@\" --skip.changelog`,\n      );\n      await execAsync(`npm publish --tag beta`);\n\n      await execAsync(`git push --follow-tags origin ${branch}`);\n    } else if (isRelease) {\n      await execAsync(\n        `standard-version --tag-prefix \"${packageName}-v\" --release-as patch --skip.changelog`,\n      );\n      await execAsync(`npm publish`);\n      await execAsync(`git push --follow-tags origin ${branch}`);\n    } else {\n      console.error(\n        `${packageName}-当前分支不是 stable 或者 release 分支，不能发布`,\n      );\n      process.exit(1);\n    }\n\n    console.log(`${packageName}-更新版本成功`);\n\n    process.chdir(catchedPath);\n\n    // 更新依赖此包的版本\n    await execAsync(`npx xrn-tools sync-dep-version ${packageName}`);\n\n    await execAsync(`yarn install --no-immutable`, { stdio: \"inherit\" });\n\n    // 有变更才提交\n    const { stdout: out } = await execAsync(`git status --porcelain`);\n    if (out.trim()) {\n      await execAsync(`git add .`);\n      await execAsync(`git commit -m \"chore: 更新依赖版本\"`);\n      await execAsync(`git push origin ${branch}`);\n    }\n  } catch (error) {\n    console.error(\"Error publishing package:\", error);\n    throw error;\n  }\n}\n"]}